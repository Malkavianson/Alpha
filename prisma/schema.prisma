generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../db.pdf"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////
// BASE / CONTROLE
//////////////////////////////////////

model UserRole {
  id    String  @id @default(uuid())
  code  String  @unique
  name  String
  users Users[]
}

model Users {
  id        String   @id @default(uuid())
  user      String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())

  role   UserRole @relation(fields: [roleId], references: [id])
  roleId String

  favorites Favorite[]
  auditLogs AuditLog[]
}

//////////////////////////////////////
// AUDITORIA FRAGMENTADA
//////////////////////////////////////

model AuditAction {
  id   String     @id @default(uuid())
  code String     @unique
  name String
  logs AuditLog[]
}

model AuditLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  entity   String
  entityId String
  before   String?
  after    String?

  action   AuditAction @relation(fields: [actionId], references: [id])
  actionId String

  user   Users  @relation(fields: [userId], references: [id])
  userId String
}

//////////////////////////////////////
// EMPRESA
//////////////////////////////////////

model Company {
  id        String   @id @default(uuid())
  name      String
  cnpj      String?
  createdAt DateTime @default(now())

  products    Product[]
  clients     Client[]
  suppliers   Supplier[]
  salesOrders SalesOrder[]
  nfe         Nfe[]
}

//////////////////////////////////////
// PRODUTOS / ESTOQUE
//////////////////////////////////////

model Category {
  id   String @id @default(uuid())
  name String
  code String @unique

  products Product[]
}

model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String?
  barcode     String?
  unit        String?  // unidade de medida
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  category   Category? @relation(fields: [categoryId], references: [id])
  categoryId String?


  stockMovements StockMovement[]
  stockBalance   StockBalance?

  nfeProduct NfeItem[]

  productSuppliers ProductSupplier[]

  salesOrderItems SalesOrderItem[]

  favorites Favorite[]
}

model StockMovementType {
  id   String @id @default(uuid())
  code String @unique
  name String

  stockMovements StockMovement[]
}

model StockMovementOrigin {
  id   String @id @default(uuid())
  code String @unique
  name String

  stockMovements StockMovement[]
}

model StockMovement {
  id        String   @id @default(uuid())
  quantity  Float
  createdAt DateTime @default(now())

  type   StockMovementType @relation(fields: [typeId], references: [id])
  typeId String

  origin   StockMovementOrigin @relation(fields: [originId], references: [id])
  originId String

  referenceId String?

  product   Product @relation(fields: [productId], references: [id])
  productId String
}

model StockBalance {
  id        String   @id @default(uuid())
  quantity  Float
  updatedAt DateTime @updatedAt

  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique
}

model Supplier {
  id            String   @id @default(uuid())
  type          String
  corporateName String   @map("razao_social")
  fantasyName   String?  @map("nome_fantasia")
  cnpj          String?
  cpf           String?
  ie            String?
  im            String?
  address       String?
  phone         String?
  email         String?
  createdAt     DateTime @default(now()) @map("created_at")

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  nfe             Nfe[]
  products        ProductSupplier[]
  accountsPayable AccountPayable[]

  @@map("supplier")
}

model ProductSupplier {
  id           String   @id @default(uuid())
  supplierCode String?
  supplierDesc String?
  createdAt    DateTime @default(now()) @map("created_at")

  product   Product @relation(fields: [productId], references: [id])
  productId String  @map("product_id")

  supplier   Supplier @relation(fields: [supplierId], references: [id])
  supplierId String   @map("supplier_id")

  @@unique([productId, supplierId])
  @@map("product_supplier")
}

//////////////////////////////////////
// COMERCIAL
//////////////////////////////////////

model ClientType {
  id   String @id @default(uuid())
  code String @unique
  name String

  clients Client[]
}

model Client {
  id            String   @id @default(uuid())
  corporateName String
  fantasyName   String?
  createdAt     DateTime @default(now())

  type   ClientType? @relation(fields: [typeId], references: [id])
  typeId String?

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  orders SalesOrder[]
}

model OrderStatus {
  id   String @id @default(uuid())
  code String @unique
  name String

  salesOrders SalesOrder[]
}

model SalesOrder {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  description String?

  status   OrderStatus @relation(fields: [statusId], references: [id])
  statusId String

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  client   Client? @relation(fields: [clientId], references: [id])
  clientId String?

  items SalesOrderItem[]
}

model SalesOrderItem {
  id        String @id @default(uuid())
  quantity  Float
  unitValue Float

  order   SalesOrder @relation(fields: [orderId], references: [id])
  orderId String

  product   Product? @relation(fields: [productId], references: [id])
  productId String?
}

//////////////////////////////////////
// FINANCEIRO
//////////////////////////////////////

model CostCenter {
  id   String @id @default(uuid())
  code String @unique
  name String

  accountsPayable    AccountPayable[]
  accountsReceivable AccountReceivable[]
}

model AccountStatus {
  id   String @id @default(uuid())
  code String @unique
  name String

  accountPayables AccountPayable[]

  accountReceivables AccountReceivable[]
}

model AccountPayable {
  id        String   @id @default(uuid())
  value     Float
  dueDate   DateTime
  createdAt DateTime @default(now())

  status   AccountStatus @relation(fields: [statusId], references: [id])
  statusId String

  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])
  costCenterId String?

  payments Payment[]

  suppliers Supplier[]
}

model AccountReceivable {
  id        String    @id @default(uuid())
  value     Float
  dueDate   DateTime?
  createdAt DateTime  @default(now())

  status   AccountStatus @relation(fields: [statusId], references: [id])
  statusId String

  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])
  costCenterId String?
}

model PaymentMethod {
  id   String @id @default(uuid())
  code String @unique
  name String

  payments Payment[]
}

model Payment {
  id          String    @id @default(uuid())
  valuePaid   Float
  paymentDate DateTime?
  createdAt   DateTime  @default(now())

  method   PaymentMethod @relation(fields: [methodId], references: [id])
  methodId String

  account          AccountPayable @relation(fields: [accountPayableId], references: [id])
  accountPayableId String
}

//////////////////////////////////////
// FISCAL (NFE)
//////////////////////////////////////

model Nfe {
  id        String   @id @default(uuid())
  number    String
  accessKey String   @unique
  issueDate DateTime
  total     Float

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  items NfeItem[]

  suppliers Supplier[]
}

model NfeItem {
  id        String @id @default(uuid())
  quantity  Float
  unitValue Float
  description String?

  product Product @relation(fields: [productId], references: [id])
  productId   String @map("product_id")

  nfe   Nfe    @relation(fields: [nfeId], references: [id])
  nfeId String
}

//////////////////////////////////////
// FAVORITOS
//////////////////////////////////////

model Favorite {
  id String @id @default(uuid())

  user   Users  @relation(fields: [userId], references: [id])
  userId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@unique([userId, productId])
}
