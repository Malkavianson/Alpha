generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../db.pdf"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////
// BASE / CONTROLE
//////////////////////////////////////

model UserRole {
  id    String  @id @default(uuid())
  code  String  @unique
  name  String
  users Users[]
}

model Users {
  id        String   @id @default(uuid())
  user      String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())

  role   UserRole @relation(fields: [roleId], references: [id])
  roleId String

  company   Company[]
  favorites Favorite[]
  auditLogs AuditLog[]
}

//////////////////////////////////////
// AUDITORIA FRAGMENTADA
//////////////////////////////////////

model AuditAction {
  id   String     @id @default(uuid())
  code String     @unique
  name String
  logs AuditLog[]
}

model AuditLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  entity   String
  entityId String
  before   String?
  after    String?

  action   AuditAction @relation(fields: [actionId], references: [id])
  actionId String

  user   Users  @relation(fields: [userId], references: [id])
  userId String
}

//////////////////////////////////////
// EMPRESA
//////////////////////////////////////

model Company {
  id                String   @id @default(uuid())
  name              String
  fantasyName       String?  @map("fantasy_name")
  cnpj              String?  @unique
  ie                String?  @map("inscricao_estadual")  // Inscrição Estadual
  im                String?  @map("inscricao_municipal") // Inscrição Municipal
  crt               String?  @map("crt")  // Código de Regime Tributário (1=Simples, 2=Normal, 3=MEI)
  cnae              String?  @map("cnae") // Código CNAE principal
  
  // Endereço Fiscal
  street            String?  @map("logradouro")
  number            String?  @map("numero")
  complement        String?  @map("complemento")
  district          String?  @map("bairro")
  city              String?  @map("cidade")
  state             String?  @map("uf")
  zipCode           String?  @map("cep")
  country           String?  @default("BRASIL")
  
  // Contato
  phone             String?
  email             String?
  website           String?
  
  // Configurações
  active            Boolean  @default(true)
  timezone          String?  @default("America/Sao_Paulo")
  currency          String?  @default("BRL")
  language          String?  @default("pt-BR")
  
  // Parâmetros Fiscais
  icmsContributor   Boolean  @map("icms_contributor") @default(false) // Contribuinte ICMS
  icmsStResponsible Boolean  @map("icms_st_responsible") @default(false) // Responsável pela retenção ICMS ST
  
  // Códigos Especiais
  suframa           String?  // Inscrição SUFRAMA
  indIncentivo      String?  @map("ind_incentivo") // Indicador de incentivo fiscal
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  suppliers         Supplier[]
  accounts          AccountIncome[]
  Users             Users[]
}

//////////////////////////////////////
// PRODUTOS / ESTOQUE
//////////////////////////////////////

model Category {
  id   String @id @default(uuid())
  name String
  code String @unique

  products Product[]
}

model Sku {
  id   String @id @default(uuid())
  name String @unique
  code String @unique

  products Product[]
}

model Product {
  id          String   @id @default(uuid())
  name        String
  barcode     String?
  unit        String? // unidade de medida
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  category   Category? @relation(fields: [categoryId], references: [id])
  categoryId String?

  stockMovements StockMovement[]
  stockBalance   StockBalance?

  nfeProduct NfeItem[]

  sku   Sku    @relation(fields: [skuId], references: [id])
  skuId String @map("sku_id")

  favorites Favorite[]
}

model StockMovement {
  id        String   @id @default(uuid())
  quantity  Float
  createdAt DateTime @default(now())
  type      String

  referenceId String?

  product   Product @relation(fields: [productId], references: [id])
  productId String
}

model StockBalance {
  id        String   @id @default(uuid())
  quantity  Float
  updatedAt DateTime @updatedAt

  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique
}

model Supplier {
  id            String   @id @default(uuid())
  corporateName String   @map("razao_social")
  fantasyName   String?  @map("nome_fantasia")
  cnpj          String?
  cpf           String?
  ie            String?
  im            String?
  address       String?
  phone         String?
  email         String?
  createdAt     DateTime @default(now()) @map("created_at")

  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  nfe             Nfe[]
  accountsPayable AccountPayable[]

  @@map("supplier")
}

//////////////////////////////////////
// FINANCEIRO
//////////////////////////////////////
model AccountType {
  id   String @id @default(uuid())
  name String @unique
  code String @unique

  accountPay AccountPayable[]
  accountInc AccountIncome[]
}

model AccountPayable {
  id             String   @id @default(uuid())
  value          Float
  expirationDate DateTime
  createdAt      DateTime @default(now())

  supplier   Supplier @relation(fields: [supplierId], references: [id])
  supplierId String

  accountType   AccountType @relation(fields: [accountTypeId], references: [id])
  accountTypeId String

  nfe   Nfe?    @relation(fields: [nfeId], references: [id])
  nfeId String?
}

model AccountIncome {
  id             String   @id @default(uuid())
  value          Float
  expirationDate DateTime
  createdAt      DateTime @default(now())

  accountType   AccountType @relation(fields: [accountTypeId], references: [id])
  accountTypeId String

  company   Company @relation(fields: [companyId], references: [id])
  companyId String
}

//////////////////////////////////////
// FISCAL (NFE)
//////////////////////////////////////

model Nfe {
  id                String   @id @default(uuid())
  number            String
  series            String   @default("1")
  model             String   @default("55") // 55=NF-e, 65=NFC-e
  type              String   @default("ENTRADA") // ENTRADA ou SAIDA
  nature            String?  @map("natureza_operacao") // Natureza da operação
  purpose           String?  @default("1") // Finalidade (1=Normal, 2=Complementar, 3=Ajuste, 4=Devolução)
  consumer          String?  @default("0") // Consumidor final (0=Normal, 1=Consumidor final)
  
  accessKey         String   @unique @map("chave_acesso")
  verificationDigit String?  @map("digito_verificador")
  
  // Datas importantes
  issueDate         DateTime @map("data_emissao")
  entryDate         DateTime? @map("data_entrada_saida")
  authorizationDate DateTime? @map("data_autorizacao")
  cancellationDate  DateTime? @map("data_cancelamento")
  
  // Valores totais
  totalProducts     Float    @map("valor_produtos")
  totalDiscount     Float?   @map("valor_desconto") @default(0)
  totalFreight      Float?   @map("valor_frete") @default(0)
  totalInsurance    Float?   @map("valor_seguro") @default(0)
  totalExpenses     Float?   @map("valor_despesas") @default(0)
  totalBaseIcms     Float?   @map("valor_base_icms")
  totalIcms         Float?   @map("valor_icms")
  totalBaseIcmsSt   Float?   @map("valor_base_icms_st")
  totalIcmsSt       Float?   @map("valor_icms_st")
  totalIpi          Float?   @map("valor_ipi")
  totalPis          Float?   @map("valor_pis")
  totalCofins       Float?   @map("valor_cofins")
  totalValue        Float    @map("valor_total")
  totalApproxTax    Float?   @map("valor_tributos_aproximado")
  
  // Informações fiscais
  cfop              String?  // CFOP principal
  paymentMethod     String?  @map("forma_pagamento")
  paymentCondition  String?  @map("condicao_pagamento")
  operationType     String?  @map("tipo_operacao") // 0=Entrada, 1=Saída
  destination       String?  @map("destino_operacao") // 1=Interna, 2=Interestadual, 3=Exterior
  
  // Status e controle
  status            String?  @default("PENDENTE") // PENDENTE, AUTORIZADA, CANCELADA, DENEGADA
  statusCode        String?  @map("codigo_status")
  statusReason      String?  @map("motivo_status")
  protocol          String?  @map("protocolo_autorizacao")
  
  // Documentos relacionados
  invoiceRef        String?  @map("nota_fiscal_referenciada")
  nfeRef            String?  @map("nfe_referenciada")
  cteRef            String?  @map("cte_referenciado")
  ecfRef            String?  @map("ecf_referenciado")
  
  // Transporte
  carrierCnpj       String?  @map("transportadora_cnpj")
  carrierName       String?  @map("transportadora_nome")
  vehiclePlate      String?  @map("placa_veiculo")
  vehicleUf         String?  @map("uf_veiculo")
  freightType       String?  @map("tipo_frete") // 0=Por conta do emitente, 1=Por conta do destinatário
  volumeQuantity    Int?     @map("quantidade_volumes")
  volumeType        String?  @map("especie_volumes")
  grossWeight       Float?   @map("peso_bruto")
  netWeight         Float?   @map("peso_liquido")
  
  // Informações adicionais
  additionalInfo    String?  @map("informacoes_adicionais")
  xml               String? 
  pdf               String? 
  danfe             String? 
  
  // Controle
  imported          Boolean  @default(false)
  manual            Boolean  @default(false)
  integrationId     String?  @map("id_integracao")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  items             NfeItem[]
  accounts          AccountPayable[]
  
  // Relacionamentos
  supplier          Supplier? @relation(fields: [supplierId], references: [id])
  supplierId        String?
}

model NfeItem {
  id                String   @id @default(uuid())
  
  // Identificação do item
  itemNumber        Int      @map("numero_item")
  code              String?  @map("codigo_produto")
  gtin              String?  @map("gtin") // Global Trade Item Number
  gtinTrib          String?  @map("gtin_tributavel")
  
  // Descrição
  description       String?
  ncm               String?  @map("ncm") // Nomenclatura Comum do Mercosul
  cest              String?  @map("cest") // Código Especificador da Substituição Tributária
  cfop              String?  @map("cfop") // Código Fiscal de Operações
  
  // Unidades
  commercialUnit    String   @map("unidade_comercial") @default("UN")
  taxUnit           String?  @map("unidade_tributavel")
  conversion        Float?   @map("fator_conversao") @default(1)
  
  // Quantidades
  quantity          Float    @map("quantidade_comercial")
  taxQuantity       Float?   @map("quantidade_tributavel")
  
  // Valores
  unitValue         Float    @map("valor_unitario")
  totalValue        Float    @map("valor_total")
  discount          Float?   @default(0)
  freight           Float?   @default(0)
  insurance         Float?   @default(0)
  otherExpenses     Float?   @map("outras_despesas") @default(0)
  
  // Origem
  origin            String?  @default("0") // 0=Nacional, 1=Estrangeira Importação Direta, etc.
  
  // ICMS
  icmsCst           String?  @map("icms_cst")
  icmsCsosn         String?  @map("icms_csosn")
  icmsOrigin        String?  @map("icms_origem")
  icmsBase          Float?   @map("icms_base_calculo")
  icmsRate          Float?   @map("icms_aliquota")
  icmsValue         Float?   @map("icms_valor")
  icmsExemptionCode String?  @map("icms_codigo_isencao")
  icmsExemptionRate Float?   @map("icms_aliquota_isencao")
  
  // ICMS ST
  icmsStBase        Float?   @map("icms_st_base_calculo")
  icmsStRate        Float?   @map("icms_st_aliquota")
  icmsStValue       Float?   @map("icms_st_valor")
  icmsStModality    String?  @map("icms_st_modalidade")
  mva               Float?   @map("mva") // Margem de Valor Agregado
  
  // IPI
  ipiCst            String?  @map("ipi_cst")
  ipiBase           Float?   @map("ipi_base_calculo")
  ipiRate           Float?   @map("ipi_aliquota")
  ipiValue          Float?   @map("ipi_valor")
  ipiEnquadramento  String?  @map("ipi_enquadramento")
  
  // PIS
  pisCst            String?  @map("pis_cst")
  pisBase           Float?   @map("pis_base_calculo")
  pisRate           Float?   @map("pis_aliquota")
  pisValue          Float?   @map("pis_valor")
  
  // COFINS
  cofinsCst         String?  @map("cofins_cst")
  cofinsBase        Float?   @map("cofins_base_calculo")
  cofinsRate        Float?   @map("cofins_aliquota")
  cofinsValue       Float?   @map("cofins_valor")
  
  // ISS (para serviços)
  issCst            String?  @map("iss_cst")
  issBase           Float?   @map("iss_base_calculo")
  issRate           Float?   @map("iss_aliquota")
  issValue          Float?   @map("iss_valor")
  issRetained       Boolean? @map("iss_retido") @default(false)
  
  // Informações complementares
  fci               String?  @map("fci") // Ficha de Conteúdo de Importação
  nve               String?  @map("nve") // Nomenclatura de Valor Aduaneiro
  indTot            String?  @map("ind_total") @default("1") // Indica se entra no total da NF
  
  // Tributos aproximados
  approxTax         Float?   @map("tributos_aproximados")
  
  // Combustíveis (se aplicável)
  anpCode           String?  @map("codigo_anp")
  blend             String?  @map("descricao_mistura")
  petroCode         String?  @map("codigo_produto_petro")
  
  // Veículos (se aplicável)
  vehicleType       String?  @map("tipo_veiculo")
  engineType        String?  @map("tipo_motor")
  chassis           String?  @map("chassi")
  color             String?  @map("cor")
  power             String?  @map("potencia")
  capacity          String?  @map("cilindrada")
  weight            String?  @map("peso")
  vin               String?  @map("vin") // Vehicle Identification Number
  
  // Medicamentos (se aplicável)
  drugRegistry      String?  @map("registro_ms")
  drugQuantity      Float?   @map("quantidade_farmaco")
  
  // Armamento (se aplicável)
  weaponType        String?  @map("tipo_arma")
  weaponSerial      String?  @map("numero_serie_arma")
  weaponCaliber     String?  @map("calibre_arma")
  
  // Informações adicionais
  additionalInfo    String?  @map("informacoes_adicionais_item")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relacionamentos
  product           Product @relation(fields: [productId], references: [id])
  productId         String  @map("product_id")

  nfe               Nfe     @relation(fields: [nfeId], references: [id])
  nfeId             String
  
  // // Para rastreabilidade de estoque
  // stockMovement     StockMovement? @relation(fields: [stockMovementId], references: [id])
  // stockMovementId   String?
  
  @@unique([nfeId, itemNumber])
}

//////////////////////////////////////
// FAVORITOS
//////////////////////////////////////

model Favorite {
  id String @id @default(uuid())

  user   Users  @relation(fields: [userId], references: [id])
  userId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@unique([userId, productId])
}